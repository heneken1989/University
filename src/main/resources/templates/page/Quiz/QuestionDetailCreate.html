<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
	layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Question</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.ckeditor.com/4.16.0/standard/ckeditor.js"></script>
<style>

    .question-box {
        border: 1px solid #000;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
    }
    .answer-section {
        margin-top: 10px;
    }
    .correct-answer {
        margin-right: 10px;
    }
</style>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css" rel="stylesheet"/>
    <!-- SweetAlert JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
</head>

<body layout:fragment="content">

    <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}">
        <!-- Error message will be displayed here -->
    </div>
    
    <div id="answersData" style="display:none"
     th:data-correct-answers="${correctAnswersJson}" 
     th:data-incorrect-answers="${incorrectAnswersJson}">
</div> 
    
 	<form id="question-form" th:action="@{/quiz/createQuestion}" th:object="${questionDto}" method="post">
 	
 	  <input type="hidden"    th:value="${quizId}"  name="quizId"  >
 	  
<div class="container mt-4">
    <div class="mb-3">
        <label for="question-type" class="form-label">Question Type</label>
        <select class="form-select" id="question-type" th:field="*{type}">
                <option value="Multi">Multiple Choice</option>
                <option value="Single">Single Correct</option>           
        </select>
        
        <p th:if="${#fields.hasErrors('type')}" th:errors="*{type}" class="text-danger">Type Error</p>
    </div>

    <div class="mb-3">
        <label for="question-text" class="form-label">Question:</label>
        <textarea id="question-text" class="form-control" th:field="*{content}" ></textarea>
         <p th:if="${#fields.hasErrors('content')}" th:errors="*{content}" class="text-danger">Type Error</p>
        
    </div>

    <div class="mb-3">
        <label for="points" class="form-label">Points:</label>
        <input type="number" id="points" class="form-control" th:field="*{mark}"  >
    </div>

    <div class="mb-3">
        <label class="form-label">Answers:</label>
        
        <div id="answers-container">
        
        
        
<div id="correct-answers">
</div>
<button type="button" id="add-correct-answer-btn" class="btn btn-success">+ Add Correct Answer</button>

<!-- Incorrect Answers -->
<div id="incorrect-answers" class="mt-3">
</div>
<button type="button" id="add-incorrect-answer-btn" class="btn btn-danger">+ Add Incorrect Answer</button>



    </div>
    <div class="d-flex justify-content-between">
        <button id="cancel-btn" class="btn btn-secondary">Cancel</button>
      <button type="submit" id="save-question-btn" class="btn btn-primary">Save Question</button>
    </div>
</div>
</div>   
    </form>
    
<script>
CKEDITOR.replace('question-text');

$('#question-form').submit(function() {
    // Ensure CKEditor content is set into the textarea
    $('textarea[name="content"]').val(CKEDITOR.instances['question-text'].getData());
    // No need to prevent default submission or use AJAX
});
</script>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:inline="javascript">
 
$('#add-correct-answer-btn').click(function() {
    // Add a new input field for a correct answer along with a delete button
    const correctAnswerHtml = `
        <div class="input-group mb-2">
            <input type="text" name="correctAnswers[]" class="form-control" placeholder="Enter correct answer">
            <button type="button" class="btn btn-danger delete-answer-btn">Delete</button>
        </div>`;
    $('#correct-answers').append(correctAnswerHtml);
});

$('#add-incorrect-answer-btn').click(function() {
    // Add a new input field for an incorrect answer along with a delete button
    const incorrectAnswerHtml = `
        <div class="input-group mb-2">
            <input type="text" name="incorrectAnswers[]" class="form-control" placeholder="Enter incorrect answer">
            <button type="button" class="btn btn-danger delete-answer-btn">Delete</button>
        </div>`;
    $('#incorrect-answers').append(incorrectAnswerHtml);
});

$('#answers-container').on('click', '.delete-answer-btn', function() {
    $(this).closest('.input-group').remove();
});


    function addCorrectAnswer(value) {
        const correctAnswerHtml = `<div class="input-group mb-2">
                                      <input type="text" name="correctAnswers[]" class="form-control" value="${value}" placeholder="Enter correct answer">
                                      <button type="button" class="btn btn-danger delete-answer-btn">Delete</button>
                                   </div>`;
        $('#correct-answers').append(correctAnswerHtml);
    }

    // Function to add a new incorrect answer input
    function addIncorrectAnswer(value) {
        const incorrectAnswerHtml = `<div class="input-group mb-2">
            <input type="text" name="incorrectAnswers[]" class="form-control mb-2" value="${value}" placeholder="Enter incorrect answer">
            <button type="button" class="btn btn-danger delete-answer-btn">Delete</button>
            </div>`;
        $('#incorrect-answers').append(incorrectAnswerHtml);
    }

    // Function to reconstruct answers based on previously inputted data
    function reconstructAnswers() {
        var correctAnswers = $('#answersData').data('correct-answers');
        var incorrectAnswers = $('#answersData').data('incorrect-answers');
        // Reconstruct correct answer inputs
        correctAnswers.forEach(function(answer) {
            addCorrectAnswer(answer);
        });
        // Reconstruct incorrect answer inputs
        incorrectAnswers.forEach(function(answer) {
            addIncorrectAnswer(answer);
        });
    }
    reconstructAnswers();
</script>

<script>
$(document).ready(function() {
    $('#question-form').submit(function(e) {
        var errorMessages = [];
        var questionContent = CKEDITOR.instances['question-text'].getData().trim();
        var points = $('#points').val().trim();

        if (!questionContent) {
            errorMessages.push("The question CONTENT cannot be empty.");
        }

        if (!points) {
            errorMessages.push("You must provide POINTS for the question");
        }

        if (Number(points) <= 0) {
            errorMessages.push("POINTS must >0");
        }

        // Check if any correct or incorrect answers have been provided
        var hasCorrectAnswers = $('#correct-answers input[type="text"]').filter(function() {
            return $.trim($(this).val()).length > 0;
        }).length > 0;

        var hasIncorrectAnswers = $('#incorrect-answers input[type="text"]').filter(function() {
            return $.trim($(this).val()).length > 0;
        }).length > 0;

        if (!hasCorrectAnswers && !hasIncorrectAnswers) {
            errorMessages.push("You must provide at least one CORRECT or INCORRECT ANSWER.");
        }

        if (errorMessages.length > 0) {
            // Prevent form submission
            e.preventDefault();
            // Show an error message with all the collected error messages
            swal("Oops!", errorMessages.join("\n"), "error");
            return; // Exit the function if there are errors
        }

        // If no errors, set the content correctly
        $('textarea[name="content"]').val(questionContent);
    });
});
</script>




<!-- <script>
$(document).ready(function() {
    $('#question-form').on('submit', function(e) {

        var formData = new FormData(this);
        formData.set('content', CKEDITOR.instances['question-text'].getData());
        $('#correct-answers input[type="text"]').each(function() {
            formData.append('correctAnswers', $(this).val());
        });
        $('#incorrect-answers input[type="text"]').each(function() {
            formData.append('incorrectAnswers', $(this).val());
        });

        var corect =  $('#correct-answers input[type="text"]');
        var xhr = new XMLHttpRequest();
        var url = '/quiz/createQuestion';
        xhr.open('POST', url, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    console.log('Question created successfully');
          
                } else {
                    console.error('Error creating question: ' + xhr.responseText);

                }
            }
        };       
        xhr.send(formData);
    });
});
</script> -->


</body>
</html>